{% extends 'base.html' %}
{% block title %}My Bookings{% endblock %}

{% block content %}
<div class="container mt-4">
  <h3><i class="bi bi-clock-history"></i> My Bookings</h3>

  {% if bookings %}
  <table class="table table-striped table-bordered align-middle mt-3">
    <thead class="table-light">
      <tr>
        <th>Booking ID</th>
        <th>Garage</th>
        <th>Services</th>
        <th>Vehicle</th>
        <th>Status</th>
        <th>Date</th>
        <th>Invoice</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for b in bookings %}
      <tr>
        <td>{{ b.booking_id }}</td>
        <td>{{ b.garage.name }}</td>

        <!-- ✅ Multiple services listed -->
        <td>
          <ul class="mb-0 ps-3">
            {% for s in b.services.all %}
              <li>{{ s.service_type.name }} <span class="text-muted">(₹{{ s.price }})</span></li>
            {% empty %}
              <li class="text-muted">No services selected</li>
            {% endfor %}
          </ul>
        </td>

        <td>{{ b.vehicle.brand }} {{ b.vehicle.model }}</td>

        <td>
          <span class="badge bg-{% if b.status == 'Completed' %}success{% elif b.status == 'In Service' %}warning{% elif b.status == 'Ready' %}info{% else %}secondary{% endif %}">
            {{ b.status }}
          </span>
        </td>

        <td>{{ b.appointment_date|date:"d M Y" }}</td>

        <!-- ✅ Invoice info -->
        <td>
          {% if b.invoice %}
            <div>
              <strong>₹{{ b.invoice.amount }}</strong><br>
              <small class="text-muted">{{ b.invoice.generated_on|date:"d M Y" }}</small>
            </div>
          {% else %}
            <span class="text-muted small">Not generated</span>
          {% endif %}
        </td>

        <td>
          <a href="{% url 'bookings:booking_detail' b.id %}" class="btn btn-sm btn-outline-primary">View</a>
          {% if b.invoice %}
            <a href="{% url 'bookings:download_invoice' b.id %}" class="btn btn-sm btn-outline-success">Invoice</a>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="alert alert-secondary mt-3">No bookings found.</div>
  {% endif %}
</div>
{% endblock %}


{% extends 'base.html' %}
{% block title %}Add Review{% endblock %}

{% block content %}
<div class="container col-md-6 mt-5">
  <div class="card shadow-sm border-0 rounded-3">
    <!-- Card Header -->
    <div class="card-header bg-primary text-white d-flex align-items-center">
      <i class="bi bi-chat-square-text me-2 fs-5"></i>
      <h5 class="mb-0">Add Review for {{ garage.name }}</h5>
    </div>

    <!-- Card Body -->
    <div class="card-body p-4">
      <form method="POST">
        {% csrf_token %}

        {% for field in form %}
        <div class="mb-3">
          <label class="form-label">{{ field.label }}</label>
          {{ field }}
          {% if field.errors %}
          <div class="text-danger small mt-1">{{ field.errors|striptags }}</div>
          {% endif %}
        </div>
        {% endfor %}

        <!-- Submit and Cancel Buttons -->
        <div class="d-flex justify-content-end mt-3">
          <button type="submit" class="btn btn-success me-2">
            <i class="bi bi-send me-1"></i> Submit Review
          </button>
          <a href="{% url 'customers:garage_detail' garage.id %}" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle me-1"></i> Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Optional Inline Styles -->
<style>
  .card-header {
    letter-spacing: 0.5px;
  }
  .form-control:focus, .form-select:focus {
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    border-color: #0d6efd;
  }
  .btn-success, .btn-outline-secondary {
    transition: transform 0.15s ease-in-out;
  }
  .btn-success:hover, .btn-outline-secondary:hover {
    transform: translateY(-1px);
  }
</style>
{% endblock %}


@login_required
def add_review(request, garage_id):
    garage = get_object_or_404(Garage, id=garage_id)
    if request.method == 'POST':
        form = ReviewForm(request.POST)
        if form.is_valid():
            review = form.save(commit=False)
            review.customer = request.user
            review.garage = garage
            review.save()
            messages.success(request, 'Thank you for your feedback!')
            return redirect('customers:garage_detail', garage_id=garage.id)
    else:
        form = ReviewForm()
    return render(request, 'customers/add_review.html', {'form': form, 'garage': garage})

